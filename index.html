<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>ç‰©å“å€Ÿå‡ºç®¡ç†ç³»ç»Ÿ</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{
    --main:#00838f;
    --success:#43a047;
    --danger:#c62828;
    --bg:#e0f7fa;
    --card:#ffffffcc;
}
* {box-sizing:border-box;margin:0;padding:0;font-family:"Microsoft YaHei",sans-serif}
body{background:var(--bg);padding:20px;}
.container{max-width:1200px;margin:auto;background:var(--card);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.1);backdrop-filter:blur(8px);}
.header{background:linear-gradient(135deg,var(--main) 0%,#006064 100%);color:#fff;padding:30px;text-align:center;}
.controls{display:flex;flex-wrap:wrap;gap:15px;padding:20px 30px;justify-content:space-between;align-items:center}
.btn{padding:10px 18px;border:none;border-radius:8px;color:#fff;font-size:14px;cursor:pointer;transition:all .3s ease}
.btn-primary{background:var(--main)}.btn-success{background:var(--success)}.btn-danger{background:var(--danger)}
.btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
.search-box{padding:10px 16px;border:1px solid #ccc;border-radius:30px;width:260px;transition:width .3s}
.search-box:focus{outline:none;border-color:var(--main);width:300px}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;padding:0 30px 20px}
.stat-card{background:var(--card);padding:20px;text-align:center;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05)}
.stat-number{font-size:32px;font-weight:700;color:var(--main)}
.table-container{padding:0 30px 30px;overflow-x:auto}
table{width:100%;border-collapse:separate;border-spacing:0;border-radius:12px;overflow:hidden;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.05)}
th,td{padding:12px;font-size:14px;text-align:center;border:1px solid #f1f1f1}
th{background:var(--main);color:#fff;position:sticky;top:0;z-index:10}
tr:nth-child(even){background:#f7f9fa}
tr:hover{background:#e3f2fd}
.status{padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600;color:#fff}
.status-returned{background:var(--success)}.status-borrowed{background:#ff9800}.status-overdue{background:var(--danger)}
.form-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:999;align-items:center;justify-content:center}
.form-box{background:#fff;border-radius:16px;padding:30px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto}
.form-group{margin-bottom:15px;display:flex;flex-wrap:wrap;align-items:center;gap:10px}
.form-group label{flex:0 0 120px;font-weight:600}
.form-group input,.form-group select,.form-group textarea{flex:1;padding:10px;border:1px solid #ccc;border-radius:8px}
.form-actions{text-align:right;margin-top:20px}
@media print{.controls,.btn,.form-modal{display:none!important}body{background:#fff}}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ“‹ ç‰©å“å€Ÿå‡ºç®¡ç†ç³»ç»Ÿ</h1>
        <p>æ–°å¢ / ç¼–è¾‘ / å½’è¿˜ / æœç´¢ / å¯¼å‡º / æ‰“å° ä¸€ç«™å¼æå®š</p>
    </div>

    <div class="controls">
        <div>
            <button class="btn btn-primary" onclick="showAddForm()">â• æ–°å¢è®°å½•</button>
            <button class="btn btn-success" onclick="exportExcel()">ğŸ“Š å¯¼å‡º Excel</button>
            <button class="btn btn-info" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°</button>
        </div>
        <input class="search-box" placeholder="ğŸ” æœç´¢ç‰©å“ã€å€Ÿç”¨äººã€éƒ¨é—¨..." onkeyup="searchTable(this.value)">
    </div>

    <div class="stats">
        <div class="stat-card"><div class="stat-number" id="st_total">0</div><div>æ€»è®°å½•</div></div>
        <div class="stat-card"><div class="stat-number" id="st_borrowed">0</div><div>åœ¨å€Ÿ</div></div>
        <div class="stat-card"><div class="stat-number" id="st_overdue">0</div><div>é€¾æœŸ</div></div>
        <div class="stat-card"><div class="stat-number" id="st_returned">0</div><div>å·²å½’è¿˜</div></div>
    </div>

    <div class="table-container">
        <table id="mainTable">
            <thead>
                <tr>
                    <th>åºå·</th><th>å€Ÿå‡ºæ—¥æœŸ</th><th>ç‰©å“åç§°</th><th>å‹å·/ç¼–å·</th><th>æ•°é‡</th>
                    <th>å€Ÿç”¨äºº</th><th>éƒ¨é—¨</th><th>è”ç³»ç”µè¯</th><th>é¢„è®¡å½’è¿˜æ—¥æœŸ</th>
                    <th>å®é™…å½’è¿˜æ—¥æœŸ</th><th>ç®¡ç†å‘˜ç­¾å­—(å€Ÿå‡º)</th><th>ç®¡ç†å‘˜ç­¾å­—(å½’è¿˜)</th><th>å¤‡æ³¨</th>
                    <th>çŠ¶æ€</th><th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- æ–°å¢/ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="form-modal" id="addModal">
    <div class="form-box">
        <h3 id="formTitle">æ–°å¢å€Ÿå‡ºè®°å½•</h3>
        <form id="addFormEl" onsubmit="saveRecord(event)">
            <div class="form-group"><label>å€Ÿå‡ºæ—¥æœŸ</label><input type="date" name="borrowDate" required></div>
            <div class="form-group"><label>ç‰©å“åç§°</label><input type="text" name="itemName" required></div>
            <div class="form-group"><label>å‹å·/ç¼–å·</label><input type="text" name="itemModel" required></div>
            <div class="form-group"><label>æ•°é‡</label><input type="number" name="quantity" min="1" required></div>
            <div class="form-group"><label>å€Ÿç”¨äºº</label><input type="text" name="borrower" required></div>
            <div class="form-group"><label>éƒ¨é—¨</label>
                <select name="department" required>
                    <option value="">è¯·é€‰æ‹©</option>
                    <option>æŠ€æœ¯éƒ¨</option><option>å¸‚åœºéƒ¨</option><option>è®¾è®¡éƒ¨</option>
                    <option>äººäº‹éƒ¨</option><option>è´¢åŠ¡éƒ¨</option><option>è¡Œæ”¿éƒ¨</option>
                </select>
            </div>
            <div class="form-group"><label>è”ç³»ç”µè¯</label><input type="tel" name="phone" required></div>
            <div class="form-group"><label>é¢„è®¡å½’è¿˜æ—¥æœŸ</label><input type="date" name="expectedReturnDate" required></div>
            <div class="form-group"><label>ç®¡ç†å‘˜ç­¾å­—(å€Ÿå‡º)</label><input type="text" name="adminBorrow" required></div>
            <div class="form-group"><label>å¤‡æ³¨</label><textarea name="remarks" rows="2"></textarea></div>
            <div class="form-actions">
                <button class="btn btn-primary" type="submit">ä¿å­˜</button>
                <button class="btn btn-secondary" type="button" onclick="closeAddModal()">å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<!-- å½’è¿˜æ¨¡æ€æ¡† -->
<div class="form-modal" id="returnModal">
    <div class="form-box">
        <h3>å½’è¿˜ç‰©å“</h3>
        <form id="returnFormEl" onsubmit="confirmReturn(event)">
            <div class="form-group"><label>å®é™…å½’è¿˜æ—¥æœŸ</label><input type="date" name="actualReturnDate" required></div>
            <div class="form-group"><label>ç®¡ç†å‘˜ç­¾å­—(å½’è¿˜)</label><input type="text" name="adminReturn" required></div>
            <div class="form-group"><label>å½’è¿˜å¤‡æ³¨</label><textarea name="returnRemarks" rows="2"></textarea></div>
            <div class="form-actions">
                <button class="btn btn-success" type="submit">ç¡®è®¤å½’è¿˜</button>
                <button class="btn btn-secondary" type="button" onclick="closeReturnModal()">å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<script>
/* ===== æ•°æ®å±‚ ===== */
let records = JSON.parse(localStorage.getItem('borrowRecords'))||[];
let editingIndex = null;
let returningIndex = null;

/* ===== DOM  shortcuts ===== */
const $ = q=>document.querySelector(q);
const $$ = q=>document.querySelectorAll(q);

/* ===== åˆå§‹åŒ– ===== */
function init(){
    renderTable();
    updateStats();
    // é»˜è®¤æ—¥æœŸ
    const today = new Date().toISOString().slice(0,10);
    $('#addFormEl borrowDate').value = today;
}
window.onload = init;

/* ===== æ¸²æŸ“ ===== */
function renderTable(list=records){
    const tbody = $('#tableBody');
    tbody.innerHTML = '';
    list.forEach((r,i)=>{
        const tr = document.createElement('tr');
        const st = getStatus(r);
        tr.innerHTML = `
            <td>${i+1}</td>
            <td>${r.borrowDate}</td><td>${r.itemName}</td><td>${r.itemModel}</td><td>${r.quantity}</td>
            <td>${r.borrower}</td><td>${r.department}</td><td>${r.phone}</td><td>${r.expectedReturnDate}</td>
            <td>${r.actualReturnDate||''}</td><td>${r.adminBorrow}</td><td>${r.adminReturn||''}</td><td>${r.remarks||''}</td>
            <td><span class="status status-${st}">${st==='returned'?'å·²å½’è¿˜':st==='overdue'?'é€¾æœŸ':'åœ¨å€Ÿ'}</span></td>
            <td>
                <button class="btn btn-primary" onclick="editRow(${i})">ç¼–è¾‘</button>
                <button class="btn btn-success" onclick="openReturn(${i})">å½’è¿˜</button>
                <button class="btn btn-danger" onclick="delRow(${i})">åˆ é™¤</button>
            </td>`;
        tbody.appendChild(tr);
    });
}
function getStatus(r){
    if(r.actualReturnDate) return 'returned';
    return new Date()>new Date(r.expectedReturnDate)?'overdue':'borrowed';
}

/* ===== ç»Ÿè®¡ ===== */
function updateStats(){
    const st = {total:records.length,returned:0,borrowed:0,overdue:0};
    records.forEach(r=>{const s=getStatus(r); st[s]++;});
    $('#st_total').textContent=st.total;
    $('#st_returned').textContent=st.returned;
    $('#st_borrowed').textContent=st.borrowed;
    $('#st_overdue').textContent=st.overdue;
}

/* ===== æ–°å¢/ç¼–è¾‘ ===== */
function showAddForm(){editingIndex=null;$('#formTitle').textContent='æ–°å¢å€Ÿå‡ºè®°å½•';$('#addModal').style.display='flex';}
function closeAddModal(){$('#addModal').style.display='none';}
function saveRecord(e){
    e.preventDefault();
    const fd = new FormData(e.target);
    const entry = Object.fromEntries(fd.entries());
    if(editingIndex===null) records.push(entry);
    else records[editingIndex]=entry;
    localStorage.setItem('borrowRecords',JSON.stringify(records));
    renderTable(); updateStats(); closeAddModal();
}
function editRow(idx){
    editingIndex=idx;
    const r = records[idx];
    $('#formTitle').textContent='ç¼–è¾‘å€Ÿå‡ºè®°å½•';
    Object.keys(r).forEach(k=>{const el=$(`[name="${k}"]`);if(el) el.value=r[k]||'';});
    $('#addModal').style.display='flex';
}

/* ===== å½’è¿˜ ===== */
function openReturn(idx){returningIndex=idx;$('#returnModal').style.display='flex';}
function closeReturnModal(){$('#returnModal').style.display='none';}
function confirmReturn(e){
    e.preventDefault();
    const fd = new FormData(e.target);
    const r = records[returningIndex];
    r.actualReturnDate = fd.get('actualReturnDate');
    r.adminReturn = fd.get('adminReturn');
    r.remarks = (r.remarks||'')+' å½’è¿˜å¤‡æ³¨ï¼š'+fd.get('returnRemarks');
    localStorage.setItem('borrowRecords',JSON.stringify(records));
    renderTable(); updateStats(); closeReturnModal();
}

/* ===== åˆ é™¤ ===== */
function delRow(idx){
    if(!confirm('ç¡®å®šåˆ é™¤è¯¥è®°å½•ï¼Ÿ')) return;
    records.splice(idx,1);
    localStorage.setItem('borrowRecords',JSON.stringify(records));
    renderTable(); updateStats();
}

/* ===== æœç´¢ ===== */
function searchTable(kw){
    const low=kw.toLowerCase();
    const filtered=records.filter(r=>
        Object.values(r).some(v=>v&&v.toString().toLowerCase().includes(low))
    );
    renderTable(filtered);
}

/* ===== å¯¼å‡º Excel ===== */
function exportExcel(){
    const ws_data = [
        ['åºå·','å€Ÿå‡ºæ—¥æœŸ','ç‰©å“åç§°','å‹å·/ç¼–å·','æ•°é‡','å€Ÿç”¨äºº','éƒ¨é—¨','è”ç³»ç”µè¯','é¢„è®¡å½’è¿˜æ—¥æœŸ','å®é™…å½’è¿˜æ—¥æœŸ','ç®¡ç†å‘˜ç­¾å­—(å€Ÿå‡º)','ç®¡ç†å‘˜ç­¾å­—(å½’è¿˜)','å¤‡æ³¨','çŠ¶æ€']
    ];
    records.forEach((r,i)=>{
        ws_data.push([
            i+1,r.borrowDate,r.itemName,r.itemModel,r.quantity,r.borrower,r.department,r.phone,
            r.expectedReturnDate,r.actualReturnDate||'',r.adminBorrow,r.adminReturn||'',r.remarks||'',
            getStatus(r)==='returned'?'å·²å½’è¿˜':getStatus(r)==='overdue'?'é€¾æœŸ':'åœ¨å€Ÿ'
        ]);
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb,ws,'å€Ÿå‡ºè®°å½•');
    XLSX.writeFile(wb,`ç‰©å“å€Ÿå‡ºè®°å½•_${new Date().toISOString().slice(0,10)}.xlsx`);
}
</script>
</body>
</html>
